<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Autós Helyfoglalás</title>
 <link rel="stylesheet" href="styles.css" />



</head>
<body>
  <header><h1>Passat Helyfoglalás</h1></header>

  <main>
			<section class="top-row">
				<div class="card free-box flex-grow top-card">
        <div class="free-item">
          <div class="muted">Péntek</div>
          <div id="fridaySeats" class="big">—</div>
          <div id="fridayDate" class="muted"></div>
        </div>
        <div class="free-item">
          <div class="muted">Vasárnap</div>
          <div id="sundaySeats" class="big">—</div>
          <div id="sundayDate" class="muted"></div>
        </div>
			</div>
    </section>

		<section class="car-area">
			<div class="card car-booking" style="display:flex;gap:16px;flex-wrap:wrap;align-items:flex-start;">
				<div class="car-visual" style="flex:1 1 420px;min-width:260px;">
					<h2 class="h2-no-margin">Autó ülések (felülnézet)</h2>

					<div style="margin-bottom:8px">
						<label class="muted">Megtekintés nap:</label>
						<select id="visualDay" style="padding:8px;border-radius:8px;margin-top:6px">
							<option value="friday">Péntek</option><option value="sunday">Vasárnap</option>
						</select>
					</div>

										<svg viewBox="0 0 480 260" width="100%" height="260" aria-hidden="false" role="img">
												<rect x="20" y="20" rx="16" ry="16" width="440" height="220" fill="#e9eef2" stroke="#c7d2d9"></rect>
												<defs>
													<!-- clip for rounded driver image -->
													<clipPath id="seat0Clip">
														<rect width="80" height="60" rx="8" ry="8" x="0" y="0" />
													</clipPath>
												</defs>

						<g id="seat-0" transform="translate(60,40)" data-seat="0" aria-hidden="true">
							<!-- Background rect (kept for layout) -->
							<rect width="80" height="60" rx="8" class="seatRect" fill="#f7fff7" stroke="#9ccc65"></rect>
					   <!-- Driver image: keep rounded corners using the clipPath; place image file `driver.png` in project root or change href -->
					   <image id="driverImg" href="driver.png" x="0" y="0" width="80" height="60" preserveAspectRatio="xMidYMid slice" clip-path="url(#seat0Clip)" />
					   <!-- Overlay stroke to keep border visible above the image -->
					   <rect width="80" height="60" rx="8" fill="none" stroke="#9ccc65" pointer-events="none"></rect>
						</g>

						<g id="seat-1" transform="translate(220,40)" data-seat="1">
							<rect width="80" height="60" rx="8" class="seatRect seat free" fill="#e6fff0" stroke="#4CAF50"></rect>
							<text x="10" y="38" font-size="14" fill="#222">Anyós</text>
						</g>

						<g id="seat-2" transform="translate(60,130)" data-seat="2">
							<rect width="80" height="60" rx="8" class="seatRect seat free" fill="#e6fff0" stroke="#4CAF50"></rect>
							<text x="10" y="38" font-size="14" fill="#222">HB</text>
						</g>

						<g id="seat-3" transform="translate(180,130)" data-seat="3">
							<rect width="80" height="60" rx="8" class="seatRect seat free" fill="#e6fff0" stroke="#4CAF50"></rect>
							<text x="10" y="38" font-size="14" fill="#222">HK</text>
						</g>

						<g id="seat-4" transform="translate(300,130)" data-seat="4">
							<rect width="80" height="60" rx="8" class="seatRect seat free" fill="#e6fff0" stroke="#4CAF50"></rect>
							<text x="10" y="38" font-size="14" fill="#222">HJ</text>
						</g>
					</svg>

					<div style="margin-top:10px" class="muted">Zöld = szabad, piros = foglalt, kék = kiválasztott (a foglalásnál). Sofőr ülés nem foglalható.</div>
				</div>

				<div class="form-side" style="flex:0 0 320px;min-width:240px;">
					<div class="card form-card-inner">
						<h2 class="h2-compact">Foglalás</h2>
						<form id="bookingForm" class="card">
							<label for="name">Neved</label>
							<input id="name" type="text" placeholder="Pl. József" required />
							<label for="day">Nap</label>
							<select id="day" required><option value="friday">Péntek</option><option value="sunday">Vasárnap</option></select>
							<label for="seatsCount">Hány helyet szeretnél?</label>
							<input id="seatsCount" type="number" min="1" max="4" value="1" required />
							<div class="muted info-text">Előbb válassz ülést a felülnézeti ábrán (opcionális), majd add meg a nevet és küldd be. Ha nem választasz, automatikusan kiosztjuk.</div>
							<button type="submit">Foglalás</button>
						</form>
					</div>
				</div>
			</div>

			<div class="card legend">
				<h3 class="h2-no-margin">Foglalások (választott nap)</h3>
				<div id="seatList"></div>
			</div>
		</section>

		<!--
		<section class="card">
			<h2 class="h2-no-margin">Összes foglalás</h2>
			<div class="table-wrap">
				<table>
					<thead><tr><th>Név</th><th>Nap</th><th>Dátum</th><th>Idő</th><th>Ül.</th></tr></thead>
					<tbody id="bookingTableBody"></tbody>
				</table>
			</div>
			<div style="margin-top:10px" class="muted">Admin oldal: <a href="admin.html">admin.html</a> (jelszó: <strong>admin</strong>)</div>
		</section>
		-->

  </main>

  <footer>&copy; RL</footer>


  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-analytics-compat.js"></script>

<script>
  // Your web app's Firebase configuration
  const FIREBASE_CONFIG = {
  apiKey: "AIzaSyBpUMFd8bvIU8IPLmbbxznkH1rwVvEE2vM",
  authDomain: "reservations-7d03f.firebaseapp.com",
  databaseURL: "https://reservations-7d03f-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "reservations-7d03f",
  storageBucket: "reservations-7d03f.firebasestorage.app",
  messagingSenderId: "543288569908",
  appId: "1:543288569908:web:db904e1f6c013246deda61",
  measurementId: "G-M7YJVQ1BHC"
};
/* ------------------------------------------------------------------------------ */

// JavaScript Optimalizálás: Globális konstansok a napokhoz és üléscímkékhez
const DAYS = {
    FRIDAY: 'friday',
    SUNDAY: 'sunday',
};
const SEAT_LABELS = {
    1: 'Első utas',
    2: 'Hátsó bal',
    3: 'Hátsó közép',
    4: 'Hátsó jobb',
    0: 'Sofőr'
};

document.addEventListener('DOMContentLoaded', () => {
  
  const app = firebase.initializeApp(FIREBASE_CONFIG);
  // const analytics = getAnalytics(app); // Visszatörölve az Analytics hiba miatt

  const db = firebase.database();

  // konstansok
  const STORAGE_KEY = 'bookings_local_cache';
  const MAX_SEATS = 4;
  
  // UI elemek
  const bookingForm = document.getElementById('bookingForm');
  const seatsCountInput = document.getElementById('seatsCount');
  const visualDay = document.getElementById('visualDay');
  const seatList = document.getElementById('seatList');
  const bookingTableBody = document.getElementById('bookingTableBody');
  const fridaySeatsEl = document.getElementById('fridaySeats');
  const sundaySeatsEl = document.getElementById('sundaySeats');
  const fridayDateEl = document.getElementById('fridayDate');
  const sundayDateEl = document.getElementById('sundayDate');

  let selectedSeats = [];
  let bookings = [];
  let nextFridayDate = '';
  let nextSundayDate = '';


  // Firebase reference
  const bookingsRef = db.ref('bookings');

  // Segédfüggvény: következő péntek/vasárnap
  function getNextDate(dayName){
    const today = new Date();
    const day = today.getDay();
    const target = dayName === DAYS.FRIDAY ? 5 : 0;
    let diff = target - day;
    if(diff <= 0) diff += 7;
    const d = new Date();
    d.setDate(today.getDate() + diff);
    return d.toISOString().split('T')[0];
  }

  // töröld a lejárt foglalásokat (client-side)
  function removeExpiredLocal(){
    const today = new Date().toISOString().split('T')[0];
    bookings = bookings.filter(b => b.date >= today);
  }

  // seat assignment: available seat indexes for date (exclude 0)
  function getTakenSeatIndexesForDate(date){
    return bookings.filter(b=>b.date===date).flatMap(b=>b.seatsAssigned || []);
  }
  function getFreeSeatIndexesForDate(date){
    const taken = getTakenSeatIndexesForDate(date);
    const pool = [1,2,3,4];
    return pool.filter(i => !taken.includes(i));
  }

  // render header boxes
  function renderHeaderBoxes(){
    const fDate = nextFridayDate;
    const sDate = nextSundayDate;
    fridayDateEl.textContent = fDate; sundayDateEl.textContent = sDate;
    fridaySeatsEl.textContent = getFreeSeatIndexesForDate(fDate).length + ' szabad hely';
    sundaySeatsEl.textContent = getFreeSeatIndexesForDate(sDate).length + ' szabad hely';
  }

  // render car visual (colors + click handlers)
  function renderCarVisual(){
    const day = visualDay.value; 
    const date = day===DAYS.FRIDAY ? nextFridayDate : nextSundayDate;

    for(let i=0;i<=4;i++){
      const rect = document.querySelector(`#seat-${i} .seatRect`) || document.querySelector(`#seat-${i} rect`);
      if(!rect) continue;
      rect.classList.remove('taken','free','selected');
      if(i===0){
        rect.setAttribute('fill','#f7fff7'); rect.setAttribute('stroke','#9ccc65');
        rect.style.cursor = 'not-allowed';
        continue;
      }
      const taken = getTakenSeatIndexesForDate(date);
      if(taken.includes(i)){
        rect.classList.add('taken');
        rect.setAttribute('fill','#ffecec'); rect.setAttribute('stroke','#e74c3c');
        rect.style.cursor = 'default';
      } else {
        if(selectedSeats.includes(i) && date === (document.getElementById('day').value === DAYS.FRIDAY ? nextFridayDate : nextSundayDate)){
          rect.classList.add('selected');
          rect.setAttribute('fill','#cfefff'); rect.setAttribute('stroke','#1e88e5');
        } else {
          rect.classList.add('free'); rect.setAttribute('fill','#e6fff0'); rect.setAttribute('stroke','#4CAF50');
        }
        rect.style.cursor = 'pointer';
      }
    }
    renderSeatListForDate(date);
  }

  // seat list for side panel
  function renderSeatListForDate(date){
    seatList.innerHTML = '';
    const dayBookings = bookings.filter(b=>b.date===date).sort((a,b)=>a.createdAt-b.createdAt);
    if(dayBookings.length === 0){
      seatList.innerHTML = '<div class="muted">Nincsenek foglalások erre a napra.</div>'; return;
    }
    const seatMap = {};
    dayBookings.forEach(b=>{
      (b.seatsAssigned || []).forEach(si=>seatMap[si] = b);
    });
    
    for(let i=1;i<=4;i++){
      const div = document.createElement('div'); div.className='seat-pill';
      const left = document.createElement('div'); left.textContent = SEAT_LABELS[i];
      const right = document.createElement('div'); right.className='muted';
      right.textContent = seatMap[i] ? seatMap[i].name : 'szabad';
      div.appendChild(left); div.appendChild(right); seatList.appendChild(div);
    }
  }

  // bookings table
  function renderBookingsTable(){
    bookingTableBody.innerHTML = '';
    const sorted = bookings.slice().sort((a,b)=> a.date===b.date ? a.createdAt-b.createdAt : (a.date > b.date ? 1 : -1));
    sorted.forEach(b=>{
      const tr = document.createElement('tr');
      const tdName = document.createElement('td'); tdName.textContent = b.name;
      const tdDay = document.createElement('td'); tdDay.textContent = (b.day===DAYS.FRIDAY?'Péntek':'Vasárnap');
      const tdDate = document.createElement('td'); tdDate.textContent = b.date;
      const tdTime = document.createElement('td'); tdTime.textContent = b.time;
      const tdSeats = document.createElement('td');
      tdSeats.textContent = (b.seatsAssigned || []).map(i => SEAT_LABELS[i] || '').join(', ');
      
      tr.appendChild(tdName); tr.appendChild(tdDay); tr.appendChild(tdDate); tr.appendChild(tdTime); tr.appendChild(tdSeats);
      bookingTableBody.appendChild(tr);
    });
  }

  // helper: auto-assign seats if user didn't select specific seats
  function assignSeatsAuto(date, seatsRequested){
    const free = getFreeSeatIndexesForDate(date);
    if(free.length < seatsRequested) return null;
    return free.slice(0,seatsRequested);
  }

  // listen to Firebase changes (realtime)
  bookingsRef.on('value', snapshot=>{
    const val = snapshot.val() || {};
    const arr = Object.keys(val).map(k => val[k]);
    bookings = arr;
    const today = new Date().toISOString().split('T')[0];
    bookings = bookings.filter(b => b.date >= today);

    nextFridayDate = getNextDate(DAYS.FRIDAY);
    nextSundayDate = getNextDate(DAYS.SUNDAY);

    renderHeaderBoxes(); renderCarVisual(); renderBookingsTable();
  });

  // handle seat clicks (select/deselect) - note: disable 0 (driver)
  for(let i=1;i<=4;i++){
    const g = document.getElementById('seat-'+i);
    g && g.addEventListener('click', () => {
      const day = document.getElementById('day').value;
      const date = day===DAYS.FRIDAY ? nextFridayDate : nextSundayDate;
      
      const taken = getTakenSeatIndexesForDate(date);
      if(taken.includes(i)){ alert('Ez az ülés már foglalt erre a napra.'); return; }
      if(selectedSeats.includes(i)) selectedSeats = selectedSeats.filter(x=>x!==i);
      else selectedSeats.push(i);
      const requested = parseInt(seatsCountInput.value,10) || 1;
      if(selectedSeats.length > requested) selectedSeats = selectedSeats.slice(0,requested);
      renderCarVisual();
    });
  }

  // form submit
  bookingForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const name = document.getElementById('name').value.trim();
    const day = document.getElementById('day').value;
    const seatsRequested = parseInt(document.getElementById('seatsCount').value,10) || 1;
    const date = day===DAYS.FRIDAY ? nextFridayDate : nextSundayDate;

    const free = getFreeSeatIndexesForDate(date);
    if(free.length < seatsRequested){
      alert('Nincs elég szabad hely erre a napra.');
      return;
    }

    let seatsAssigned = [];
    if(selectedSeats.length > 0) {
      seatsAssigned = selectedSeats.slice(0,seatsRequested).filter(i => free.includes(i));
      if(seatsAssigned.length < seatsRequested) {
        const remaining = seatsRequested - seatsAssigned.length;
        const freeNow = free.filter(i => !seatsAssigned.includes(i));
        seatsAssigned = seatsAssigned.concat(freeNow.slice(0,remaining));
      }
    } else {
      seatsAssigned = assignSeatsAuto(date,seatsRequested);
    }
    if(!seatsAssigned || seatsAssigned.length < seatsRequested){
      alert('Hiba: nem sikerült ülés kiosztani.');
      return;
    }

    const time = new Date().toLocaleTimeString('hu-HU');
    const newObj = {
      id: Date.now() + '-' + Math.floor(Math.random()*100000),
      name, day, date, time, seats: seatsRequested, seatsAssigned, createdAt: Date.now()
    };

    const newRef = bookingsRef.push();
    await newRef.set(newObj);

    bookingForm.reset();
    selectedSeats = [];
    alert('Foglalás sikeres!');
  });

  // visualDay change updates graphic
  visualDay.addEventListener('change', renderCarVisual);
  document.getElementById('day').addEventListener('change', ()=>{ selectedSeats = []; renderCarVisual(); });

  // initial render
  nextFridayDate = getNextDate(DAYS.FRIDAY);
  nextSundayDate = getNextDate(DAYS.SUNDAY);

  renderHeaderBoxes();
  renderCarVisual();
  renderBookingsTable();
  });
</script>
</body>
</html>


